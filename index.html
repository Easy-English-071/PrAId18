<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrAI - Luyện Phát Âm với AI</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23242D38'/%3E%3Ctext x='50' y='70' font-family='Exo 2, sans-serif' font-size='50' font-weight='bold' text-anchor='middle' fill='%234A80F0'%3EPr%3Ctspan fill='%23EAEFF5'%3EAI%3C/tspan%3E%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans:wght@400;700&family=Exo+2:wght@700&display=swap" rel="stylesheet">
    <style>
        /*
          New Color Palette:
          --bg-gradient-start: #2A3440;
          --bg-gradient-end: #1E252E;
          --card-bg: #242D38;
          --layer-bg: #2A3440;
          --layer-inset-bg: #1E252E;
          --text-primary: #EAEFF5;
          --text-secondary: #8A99AB;
          --accent-primary: #4A80F0;
          --accent-danger: #E5484D;
          --accent-success: #34A853;
          --accent-warning: #F6AD3C;
          --highlight-correct: rgba(52, 168, 83, 0.15);
          --highlight-approximate: rgba(246, 173, 60, 0.15);
          --highlight-incorrect: rgba(229, 72, 77, 0.15);
          --border-color: rgba(138, 153, 171, 0.2);
        */

        :root {
            --bg-gradient-start: #2A3440;
            --bg-gradient-end: #1E252E;
            --card-bg: #242D38;
            --layer-bg: #2A3440;
            --layer-inset-bg: #1E252E;
            --text-primary: #EAEFF5;
            --text-secondary: #8A99AB;
            --accent-primary: #4A80F0;
            --accent-danger: #E5484D;
            --accent-success: #34A853;
            --accent-warning: #F6AD3C;
            --highlight-correct: rgba(52, 168, 83, 0.15);
            --highlight-approximate: rgba(246, 173, 60, 0.15);
            --highlight-incorrect: rgba(229, 72, 77, 0.15);
            --border-color: rgba(138, 153, 171, 0.2);

            --radius-sm: 0.75rem; /* 12px */
            --radius-md: 1rem; /* 16px */
            --radius-lg: 1.5rem; /* 24px */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(170deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .font-logo {
            font-family: 'Exo 2', sans-serif;
            color: var(--text-primary);
        }

        #simple-ipa-text, #detailed-ipa-text, .phoneme, .ipa-text {
            font-family: 'Noto Sans', sans-serif;
        }
        
        #simple-ipa-text, #detailed-ipa-text {
            word-break: break-word;
        }

        /* Main Layout Structure */
        .main-card {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: clamp(1rem, 5vw, 2.5rem);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease-in-out;
        }

        .card-layer {
            background: linear-gradient(145deg, var(--layer-bg), var(--card-bg));
            padding: 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
        }

        .card-layer-inset {
            background-color: var(--layer-inset-bg);
            padding: 1rem;
            border-radius: var(--radius-md);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            border: 1px solid rgba(0,0,0,0.3);
        }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.05);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.05);
        }
        .btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.05);
        }
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: var(--layer-bg);
            border-color: var(--border-color);
        }

        .btn-primary {
            background-color: var(--accent-primary);
            color: var(--text-primary);
            border-color: transparent;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #5a8cf1;
        }

        .btn-secondary {
            background-color: var(--layer-bg);
            color: var(--text-secondary);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 3rem; /* 48px */
            height: 3rem; /* 48px */
            border-radius: 50%;
            background-color: var(--layer-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0; /* Prevents button from shrinking */
        }
        .btn-icon:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            background-color: var(--card-bg);
            color: var(--text-primary);
        }
        .btn-icon:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-record {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 7rem;
            height: 7rem;
            border-radius: 50%;
            background: var(--accent-danger);
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(229, 72, 77, 0.25), inset 0 -5px 10px rgba(0,0,0,0.2);
            transition: all 0.2s ease-in-out;
            flex-direction: column;
            border: 3px solid var(--card-bg);
            flex-shrink: 0;
        }

        .btn-record:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 15px 25px rgba(229, 72, 77, 0.3), inset 0 -5px 10px rgba(0,0,0,0.2);
        }
        .btn-record.is-recording {
            background: var(--accent-danger);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 10px 20px rgba(229, 72, 77, 0.25), inset 0 -5px 10px rgba(0,0,0,0.2), 0 0 0 0 rgba(229, 72, 77, 0.4); }
            70% { box-shadow: 0 10px 20px rgba(229, 72, 77, 0.25), inset 0 -5px 10px rgba(0,0,0,0.2), 0 0 0 10px rgba(229, 72, 77, 0); }
            100% { box-shadow: 0 10px 20px rgba(229, 72, 77, 0.25), inset 0 -5px 10px rgba(0,0,0,0.2), 0 0 0 0 rgba(229, 72, 77, 0); }
        }

        /* --- Inputs & Forms --- */
        .input-field {
            width: 100%;
            background-color: var(--layer-inset-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            background-color: var(--card-bg);
            box-shadow: 0 0 0 3px rgba(74, 128, 240, 0.3);
        }
        textarea.input-field {
            resize: vertical;
            min-height: 80px;
        }

        /* --- Analysis & Display --- */
        .phoneme {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            position: relative;
            transition: all 0.2s ease-in-out;
            background-color: var(--layer-inset-bg);
            color: var(--text-secondary);
        }
        .phoneme.status-correct {
            background-color: var(--highlight-correct);
            color: #81C995; /* Lighter green text */
        }
        .phoneme.status-approximate {
            background-color: var(--highlight-approximate);
            color: #FDD663; /* Lighter yellow text */
        }
        .phoneme.status-incorrect {
            background-color: var(--highlight-incorrect);
            color: #F28B82; /* Lighter red text */
        }

        .has-tooltip:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .tooltip {
            visibility: hidden; opacity: 0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translate(-50%, 10px);
            background-color: #12151a;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            z-index: 20;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible; opacity: 1;
            transform: translate(-50%, -5px);
        }
        
        /* --- SCORE UPDATE: Made score container larger and added dynamic borders/shadows --- */
        .score-container {
            background: radial-gradient(circle, rgba(74, 128, 240, 0.15) 0%, rgba(74, 128, 240, 0) 70%);
            padding: 0.5rem;
            border-radius: 50%;
            width: 140px; /* Increased size */
            height: 140px; /* Increased size */
            margin: 1rem auto; /* More space */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease-out;
            border: 4px solid transparent; /* Prevents layout shift on border change */
        }
        .score-container.score-high {
            border-color: var(--accent-success);
            box-shadow: 0 0 20px rgba(52, 168, 83, 0.4);
        }
        .score-container.score-medium {
            border-color: var(--accent-warning);
            box-shadow: 0 0 20px rgba(246, 173, 60, 0.4);
        }
        .score-container.score-low {
            border-color: var(--accent-danger);
            box-shadow: 0 0 20px rgba(229, 72, 77, 0.4);
        }
        
        #overall-score {
            font-size: 3.5rem; /* Increased font size */
            font-weight: 700;
            color: var(--text-primary); /* Default color */
            transition: color 0.5s ease-out;
        }
        .score-high #overall-score { color: var(--accent-success); }
        .score-medium #overall-score { color: var(--accent-warning); }
        .score-low #overall-score { color: var(--accent-danger); }
        /* --- END SCORE UPDATE --- */

        #detailed-ipa-text {
            color: var(--accent-primary);
        }

        .thought-group {
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            margin: 0.1rem;
            display: inline-block;
            transition: background-color 0.3s;
        }
        
        /* Connected Speech Styling */
        .connected-speech-item {
            border-left: 3px solid var(--accent-primary);
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
        
        /* --- FEEDBACK UPDATE: Made feedback background stand out more --- */
        .connected-speech-feedback {
            background-color: var(--card-bg); /* Lighter than inset */
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.75rem;
            margin-top: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* --- END FEEDBACK UPDATE --- */

        .connected-speech-label {
            color: var(--text-secondary);
            font-weight: 600;
        }
        .ipa-text-highlight {
            color: var(--accent-warning);
            font-family: 'Noto Sans', sans-serif;
        }

        /* --- Loader & Animations --- */
        .progress-bar {
            width: 100%;
            background-color: var(--layer-inset-bg);
            border-radius: 9999px;
            height: 0.75rem;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }
        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-primary) 0%, #81C995 100%);
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }

        .btn-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-fade-in { animation: modalFadeIn 0.3s ease-out forwards; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content-fade-in { animation: modalContentFadeIn 0.3s ease-out forwards; }
        @keyframes modalContentFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }


        /* --- Waveform --- */
        #waveform-container {
            transition: all 0.3s ease-in-out;
        }
        #waveform {
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
        }

        /* Message Box */
        #message-box {
            background-color: var(--layer-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
        }
        
        /* --- History Modal --- */
        .history-item {
            background-color: var(--layer-inset-bg);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease-in-out;
        }
        .history-item:hover {
            background-color: var(--layer-bg);
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }
        .history-score {
            width: 50px;
            height: 50px;
            flex-shrink: 0;
        }
        .history-score.score-high { border-color: var(--accent-success); color: var(--accent-success); }
        .history-score.score-medium { border-color: var(--accent-warning); color: var(--accent-warning); }
        .history-score.score-low { border-color: var(--accent-danger); color: var(--accent-danger); }
        
        /* Custom scrollbar for history list */
        #history-list::-webkit-scrollbar {
            width: 8px;
        }
        #history-list::-webkit-scrollbar-track {
            background: var(--layer-inset-bg);
            border-radius: 10px;
        }
        #history-list::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 10px;
        }
        #history-list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

    </style>
</head>
<body class="antialiased">
    <div class="w-full max-w-3xl mx-auto p-4 relative">
        <!-- Header Section -->
        <header class="text-center mb-8 fade-in relative">
            <h1 class="text-6xl md:text-7xl font-bold font-logo">PrAI</h1>
            <p class="text-text-secondary">Trợ lý luyện phát âm AI của bạn</p>
            <!-- History Button -->
            <button id="history-btn" class="btn-icon absolute top-0 right-0" title="Lịch sử Luyện tập">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>
            </button>
        </header>

        <!-- Main Card -->
        <main class="main-card space-y-8">
            <!-- Input Section -->
            <section class="input-section card-layer space-y-4">
                <div>
                    <label for="text-input" class="block text-lg font-semibold text-text-primary mb-3">Nhập văn bản cần luyện tập:</label>
                    <textarea id="text-input" rows="3" maxlength="150" class="input-field" placeholder="Ví dụ: What are you doing?"></textarea>
                    <div id="char-counter" class="text-right text-sm text-text-secondary mt-1">0 / 150</div>
                    <div class="mt-4 flex flex-col sm:flex-row items-center gap-4">
                        <div class="flex-grow w-full">
                            <label for="accent-select" class="block text-sm font-medium text-text-secondary mb-1">Chọn giọng:</label>
                            <select id="accent-select" class="input-field">
                                <option value="British English" selected>Anh - Anh (BrE)</option>
                                <option value="American English">Anh - Mỹ (AmE)</option>
                            </select>
                        </div>
                        <div class="flex-shrink-0 flex gap-3 self-end">
                            <button id="random-practice-btn" class="btn btn-secondary">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                                <span class="text">Ngẫu nhiên</span>
                            </button>
                             <button id="transcribe-btn" class="btn btn-primary">
                                 <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                 <span class="text">Phiên âm</span>
                                 <div class="btn-spinner hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                             </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- IPA, Thought Groups & Controls Section -->
            <section id="controls-section" class="hidden space-y-6">
                 <div class="card-layer space-y-4">
                     <div class="flex items-center justify-between">
                         <div class="min-w-0">
                             <h3 class="font-semibold text-text-secondary text-md">Phiên âm cơ bản</h3>
                             <p id="simple-ipa-text" class="text-lg text-text-primary tracking-wider"></p>
                         </div>
                         <button id="listen-clear-btn" class="btn-icon">
                             <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                             <div class="btn-spinner hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                         </button>
                     </div>
                     <div class="flex items-center justify-between">
                         <div class="min-w-0">
                             <div class="flex items-center gap-2 mb-1">
                                 <h3 class="font-semibold text-text-secondary text-md">Phiên âm & Cụm tư duy</h3>
                                 <div id="thought-group-info" class="has-tooltip relative hidden">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-text-secondary cursor-pointer"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                                     <div id="thought-group-tooltip" class="tooltip absolute bottom-full left-1/2 mb-2 w-72 rounded-lg p-3 text-xs shadow-lg"></div>
                                 </div>
                             </div>
                             <div class="space-y-2">
                                 <p id="detailed-ipa-text" class="text-xl text-accent-primary tracking-wider"></p>
                                 <div id="thought-group-display" class="text-lg text-text-primary tracking-wide leading-relaxed"></div>
                             </div>
                         </div>
                         <button id="listen-natural-btn" class="btn-icon">
                             <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                             <div class="btn-spinner hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                         </button>
                     </div>
                 </div>

                <div class="flex flex-col items-center justify-center gap-4 pt-4">
                    <div id="record-controls" class="flex items-center justify-center gap-6 w-full h-28">
                        <button id="upload-btn" class="btn-icon btn-secondary">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        </button>
                        <button id="record-btn" class="btn-record">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                            <span class="text hidden">Dừng</span>
                        </button>
                        <button id="listen-again-btn" disabled class="btn-icon btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                        </button>
                    </div>
                    <div id="waveform-container" class="hidden h-20 w-full card-layer-inset flex items-center justify-center p-2">
                        <canvas id="waveform" class="w-full h-full"></canvas>
                    </div>
                </div>
            </section>

            <!-- Loader -->
            <div id="loader" class="text-center hidden py-4 flex flex-col items-center justify-center">
                <div class="progress-bar w-full max-w-xs">
                    <div class="progress-bar-inner"></div>
                </div>
                <p id="progress-text" class="text-text-secondary mt-4">PrAI đang lắng nghe và phân tích...</p>
                <p id="fun-fact" class="text-sm text-text-secondary/70 mt-6 italic hidden"></p>
            </div>

            <!-- Analysis Results -->
            <section id="analysis-results" class="hidden space-y-6">
                <div class="card-layer space-y-4">
                    <h3 class="font-bold text-text-primary text-xl">Kết quả Phân tích</h3>
                    <div class="score-container">
                        <p><span id="overall-score"></span><span class="text-xl text-text-secondary">/100</span></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-text-secondary mb-2">Phân tích Âm vị</h4>
                        <div id="phoneme-analysis" class="flex flex-wrap gap-2 p-3 card-layer-inset rounded-lg"></div>
                        <p class="text-xs text-text-secondary mt-2">Chạm hoặc di chuột qua các âm vị để xem hướng dẫn.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-text-secondary mb-2">Phân tích Trọng âm</h4>
                        <div id="stress-analysis" class="p-3 card-layer-inset rounded-lg"></div>
                    </div>
                     <div id="thought-group-analysis-result" class="hidden">
                         <h4 class="font-semibold text-text-secondary mb-2">Phân tích Cụm Tư Duy</h4>
                         <div id="thought-group-feedback" class="p-3 card-layer-inset rounded-lg"></div>
                     </div>
                </div>
                
                <div id="advanced-analysis" class="hidden space-y-4 card-layer">
                    <h3 class="font-bold text-text-primary text-xl">Phân tích Nâng cao</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-text-secondary mb-2">Ngữ điệu (Intonation)</h4>
                            <div id="intonation-analysis" class="p-3 card-layer-inset rounded-lg"></div>
                        </div>
                         <div>
                            <h4 class="font-semibold text-text-secondary mb-2">Nối âm (Connected Speech)</h4>
                            <div id="connected-speech-analysis" class="p-3 card-layer-inset rounded-lg space-y-4"></div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button id="show-more-btn" class="hidden btn btn-secondary">
                        Thông tin thêm
                    </button>
                </div>

                 <div id="practice-suggestions" class="hidden card-layer">
                     <h3 class="font-bold text-text-primary text-xl mb-4">Xem ví dụ thực tế</h3>
                     <div id="suggestion-links" class="flex flex-col sm:flex-row gap-3 mt-2"></div>
                 </div>
            </section>
        </main>

        <!-- Message Box -->
        <div id="message-box" class="fixed bottom-5 right-5 hidden p-4 rounded-xl text-sm z-50 shadow-lg"></div>
        <audio id="replay-audio" class="hidden"></audio>
        <input type="file" id="audio-upload-input" class="hidden" accept="audio/*">

        <!-- Footer -->
        <footer class="text-center mt-8 text-text-secondary text-sm">
            <p>© 2025 PrAI. Được tạo ra với niềm đam mê ngôn ngữ bởi Mr Bảo.</p>
        </footer>
    </div>
    
    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 modal-fade-in">
        <div id="history-modal-content" class="main-card w-full max-w-2xl max-h-[80vh] flex flex-col modal-content-fade-in">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-text-primary">Lịch sử Luyện tập</h2>
                <button id="close-history-btn" class="btn-icon text-2xl leading-none">
                    &times;
                </button>
            </div>
            <div id="history-list" class="overflow-y-auto space-y-3 pr-2 flex-grow">
                <!-- History items will be injected here -->
            </div>
             <div id="clear-history-btn-container" class="text-center mt-4 flex-shrink-0">
                <button id="clear-history-btn" class="btn btn-secondary">Xóa Lịch sử</button>
            </div>
        </div>
    </div>


    <script type="module">
        // DOM Elements
        const textInput = document.getElementById('text-input');
        const accentSelect = document.getElementById('accent-select');
        const transcribeBtn = document.getElementById('transcribe-btn');
        const listenNaturalBtn = document.getElementById('listen-natural-btn');
        const listenClearBtn = document.getElementById('listen-clear-btn');
        const recordControls = document.getElementById('record-controls');
        const uploadBtn = document.getElementById('upload-btn');
        const recordBtn = document.getElementById('record-btn');
        const listenAgainBtn = document.getElementById('listen-again-btn');
        const randomPracticeBtn = document.getElementById('random-practice-btn');
        const controlsSection = document.getElementById('controls-section');
        const loader = document.getElementById('loader');
        const simpleIpaText = document.getElementById('simple-ipa-text');
        const detailedIpaText = document.getElementById('detailed-ipa-text');
        const analysisResults = document.getElementById('analysis-results');
        const overallScore = document.getElementById('overall-score');
        const phonemeAnalysis = document.getElementById('phoneme-analysis');
        const stressAnalysis = document.getElementById('stress-analysis');
        const practiceSuggestions = document.getElementById('practice-suggestions');
        const suggestionLinks = document.getElementById('suggestion-links');
        const messageBox = document.getElementById('message-box');
        const waveformContainer = document.getElementById('waveform-container');
        const waveformEl = document.getElementById('waveform');
        const replayAudio = document.getElementById('replay-audio');
        const audioUploadInput = document.getElementById('audio-upload-input');
        const funFactEl = document.getElementById('fun-fact');
        const showMoreBtn = document.getElementById('show-more-btn');
        const advancedAnalysis = document.getElementById('advanced-analysis');
        const intonationAnalysis = document.getElementById('intonation-analysis');
        const connectedSpeechAnalysis = document.getElementById('connected-speech-analysis');
        const progressText = document.getElementById('progress-text');
        const charCounter = document.getElementById('char-counter');
        const thoughtGroupDisplay = document.getElementById('thought-group-display');
        const thoughtGroupInfo = document.getElementById('thought-group-info');
        const thoughtGroupTooltip = document.getElementById('thought-group-tooltip');
        const thoughtGroupAnalysisResult = document.getElementById('thought-group-analysis-result');
        const thoughtGroupFeedback = document.getElementById('thought-group-feedback');
        
        // History Modal Elements
        const historyBtn = document.getElementById('history-btn');
        const historyModal = document.getElementById('history-modal');
        const historyModalContent = document.getElementById('history-modal-content');
        const closeHistoryBtn = document.getElementById('close-history-btn');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');


        // State variables
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let standardIPA = '';
        let ipaForText = '';
        let audioContext;
        let analyser;
        let waveformAnimationId;
        let lastRecordingBlob = null;
        let soundDetected = false;
        let ipaLoadingInterval;
        let lastTTSAudioNatural = null;
        let lastTTSTextNatural = '';
        let lastTTSAccentNatural = '';
        let lastTTSAudioClear = null;
        let lastTTSTextClear = '';
        let lastTTSAccentClear = '';
        let fetchIpaRequestID = 0;
        let analysisRequestID = 0; // <-- New state for cancelling analysis
        let progressInterval;
        let progressTextInterval;
        let currentThoughtGroups = [];
        let currentIpaData = {}; // To store IPA data for history

        // --- DATA & CONFIG ---
        const funFacts = [
            "'Ough' có thể được phát âm theo 10 cách khác nhau.",
            "Âm câm (silent letters) là di tích lịch sử từ các ngôn ngữ khác.",
            "'Pronunciation' (phát âm) trớ trêu lại là từ bị phát âm sai nhiều nhất.",
            "Tiếng Anh có tới 20 âm nguyên âm theo hệ thống IPA, nhiều hơn hầu hết các ngôn ngữ khác.",
            "'Strengths' là từ dài nhất chỉ có một nguyên âm.",
            "'Rhythms' là từ dài nhất không có nguyên âm (a, e, i, o, u).",
            "'Bookkeeper' là từ duy nhất có ba cặp chữ cái lặp lại liên tiếp.",
            "Câu 'Buffalo buffalo Buffalo buffalo buffalo buffalo Buffalo buffalo.' là một câu đúng ngữ pháp.",
            "Từ 'set' có nhiều định nghĩa nhất trong tiếng Anh, với hơn 430 nghĩa khác nhau.",
            "'Queueing' là từ duy nhất có năm nguyên âm đi liền nhau.",
            "'I am' là câu hoàn chỉnh ngắn nhất trong tiếng Anh.",
            "Câu 'The quick brown fox jumps over the lazy dog' chứa tất cả 26 chữ cái.",
            "Không có từ nào trong tiếng Anh vần với 'month', 'orange', 'silver' hay 'purple'.",
            "'Uncopyrightable' là từ dài nhất không lặp lại bất kỳ chữ cái nào.",
            "Shakespeare đã sáng tạo ra hơn 1,700 từ cho tiếng Anh, ví dụ như 'eyeball', 'swagger', 'bedazzled'."
        ];

        const practiceSentences = [
            "What are you doing?", "It's a piece of cake.", "I'll call you back later.",
            "How's it going?", "Can I have a bottle of water, please?", "It's a beautiful day, isn't it?",
            "I'm looking forward to it.", "Could you please repeat that?", "Where is the nearest station?",
            "Can you help me, please?", "I don't understand.", "Could you repeat that, please?",
            "Could you please talk slower?", "What does this mean?", "How do you spell that?",
            "What do you think?", "That sounds great.", "That's a good idea.", "I have no idea.",
            "I'm not sure.", "Could you give me a hand with this?", "Piece of cake", "Break a leg",
            "Under the weather", "Hit the books", "Call it a day", "What have you been up to?",
            "Is everything okay?", "Take care.", "Let me know if you need anything.", "I'm here for you."
        ];

        const thoughtGroupColors = [
            'bg-blue-500/10 text-blue-300', 
            'bg-green-500/10 text-green-300', 
            'bg-purple-500/10 text-purple-300',
            'bg-yellow-500/10 text-yellow-300'
        ];


        // API Configuration
        const apiKey = "AIzaSyBa0ieUPwXxb-W_fFHbB-ldEJG8-sAFxN0"; // API key will be managed by the environment
        const TEXT_MODEL = "gemini-2.5-flash-preview-05-20";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;


        // --- UTILITY FUNCTIONS ---

        function showMessage(message, type = 'info') {
            const baseClasses = 'fixed bottom-5 right-5 p-4 rounded-xl text-sm z-50 shadow-lg border fade-in';
            const typeClasses = {
                'info': 'bg-accent-primary/20 text-blue-300 border-accent-primary/30',
                'success': 'bg-accent-success/20 text-green-300 border-accent-success/30',
                'warning': 'bg-accent-warning/20 text-yellow-300 border-accent-warning/30',
                'error': 'bg-accent-danger/20 text-red-300 border-accent-danger/30'
            };
            messageBox.className = `${baseClasses} ${typeClasses[type]}`;
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        function handleApiError(error) {
            console.error("API Error:", error);
            if (error.message && (error.message.includes('429') || error.message.toLowerCase().includes('quota'))) {
                showMessage('Hệ thống đang bận. Bạn vui lòng thử lại sau nhé.', 'error');
            } else {
                showMessage(`Đã xảy ra lỗi kết nối: ${error.message}`, 'error');
            }
        }

        function setButtonLoading(button, isLoading) {
            const textEl = button.querySelector('.text');
            const iconEl = button.querySelector('.icon');
            const spinnerEl = button.querySelector('.btn-spinner');
            button.disabled = isLoading;
            if (isLoading) {
                if(textEl) textEl.style.display = 'none';
                if(iconEl) iconEl.style.display = 'none';
                if(spinnerEl) spinnerEl.classList.remove('hidden');
            } else {
                if(textEl) textEl.style.display = 'inline';
                if(iconEl) iconEl.style.display = 'block';
                if(spinnerEl) spinnerEl.classList.add('hidden');
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1, bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * bitsPerSample / 8;
            const blockAlign = numChannels * bitsPerSample / 8;
            const dataSize = pcmData.length * 2;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        // --- API & CORE LOGIC ---

        async function fetchWithBackoff(url, options, maxRetries = 4) {
             let delay = 1000;
             for (let i = 0; i < maxRetries; i++) {
                 try {
                     const response = await fetch(url, options);
                     if (response.status === 429 || response.status >= 500) {
                         if (i === maxRetries - 1) {
                             const errorBody = await response.json().catch(() => ({}));
                             throw new Error(`API Error: ${response.status}. ${errorBody.error?.message || 'Server error after multiple retries.'}`);
                         }
                         await new Promise(resolve => setTimeout(resolve, delay));
                         delay *= 2; 
                         continue; 
                     }
                     if (!response.ok) {
                         const errorBody = await response.json().catch(() => ({}));
                         throw new Error(`API Error: ${response.status}. ${errorBody.error?.message || 'An unknown error occurred.'}`);
                     }
                     return await response.json();
                 } catch (error) {
                     if (i === maxRetries - 1) {
                         throw error;
                     }
                     await new Promise(resolve => setTimeout(resolve, delay));
                     delay *= 2;
                 }
             }
         }

        function startIpaLoadingAnimation() {
            clearInterval(ipaLoadingInterval);
            const ipaSymbols = ['ə', 'ʃ', 't', 'd', 'k', 'æ', 'iː', 'θ', 'ð', 'ŋ', 'w', 'j', 'r', 'l', 's', 'z'];
            let i = 0;
            ipaLoadingInterval = setInterval(() => {
                const symbolSequence = Array(5).fill(0).map((_, j) => ipaSymbols[(i + j) % ipaSymbols.length]).join(' ');
                simpleIpaText.textContent = `/ ${symbolSequence} /`;
                detailedIpaText.textContent = `[ ${symbolSequence} ]`;
                thoughtGroupDisplay.textContent = `...`;
                i = (i + 1) % ipaSymbols.length;
            }, 100);
        }

        function stopIpaLoadingAnimation() {
            clearInterval(ipaLoadingInterval);
        }

        async function fetchAndDisplayIPA() {
            fetchIpaRequestID++;
            const currentRequestID = fetchIpaRequestID;

            const text = textInput.value.trim();
            if (!text) {
                resetAll();
                return false;
            }
            
            if (ipaForText === text && accentSelect.value === document.body.dataset.accent) {
                controlsSection.classList.remove('hidden');
                thoughtGroupInfo.classList.toggle('hidden', !text.includes(' '));
                return true;
            }

            const accent = accentSelect.value;
            const combinedPrompt = `For the phrase "${text}" in ${accent}, provide a single JSON object with the following keys:
            1.  'simple': A standard, citation-form IPA transcription.
            2.  'detailed': A natural, connected speech transcription. IMPORTANT: This transcription must reflect the thought groups. Show linking (liaison with ‿) **only within** each thought group, not across them. The boundary between groups acts as a hard stop for linking.
            3.  'thought_groups': An object containing two keys:
                a. 'groups': An array of strings representing the most natural, semantically-driven thought groups. This array must ONLY contain the text segments of the phrase, nothing else. Prioritize natural flow over rigid grammatical rules. For short phrases (e.g., "What does this mean?"), keep them as a single group. Avoid isolating single words unless for strong, specific emphasis.
                b. 'explanation': A brief, friendly explanation in Vietnamese for the suggested grouping. Explain the linguistic reason for the pause, for example: "Đây là một cách ngắt nghỉ tự nhiên. Chúng ta thường có một điểm dừng nhẹ sau cụm 'What does this mean' để tách biệt ý hỏi chính, giúp người nghe dễ dàng tiếp nhận thông tin."
            Respond with ONLY the JSON object.`;
            
            setButtonLoading(transcribeBtn, true);
            controlsSection.classList.remove('hidden');
            thoughtGroupDisplay.classList.toggle('hidden', !text.includes(' '));
            thoughtGroupInfo.classList.toggle('hidden', !text.includes(' '));
            
            startIpaLoadingAnimation();
            
            try {
                const payload = { 
                    contents: [{ parts: [{ text: combinedPrompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetchWithBackoff(TEXT_API_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if (currentRequestID !== fetchIpaRequestID) return false;

                const resultText = response.candidates[0].content.parts[0].text;
                const resultJson = JSON.parse(resultText);
                
                // Store data for history
                currentIpaData = {
                    simple: resultJson.simple,
                    detailed: resultJson.detailed,
                    thought_groups: resultJson.thought_groups
                };

                standardIPA = resultJson.detailed;
                ipaForText = text;
                document.body.dataset.accent = accent;
                
                simpleIpaText.textContent = resultJson.simple;
                detailedIpaText.textContent = resultJson.detailed;

                if (resultJson.thought_groups && text.includes(' ')) {
                    currentThoughtGroups = resultJson.thought_groups.groups;
                    displayThoughtGroups(resultJson.thought_groups.groups, resultJson.thought_groups.explanation);
                } else {
                    currentThoughtGroups = [];
                    displayThoughtGroups([], '');
                }
                
                return true;
            } catch (error) {
                if (currentRequestID === fetchIpaRequestID) {
                    handleApiError(error);
                    resetAll();
                }
                return false;
            } finally {
                if (currentRequestID === fetchIpaRequestID) {
                    stopIpaLoadingAnimation();
                    setButtonLoading(transcribeBtn, false);
                }
            }
        }

        function displayThoughtGroups(groups, explanation) {
            thoughtGroupDisplay.innerHTML = '';
            thoughtGroupTooltip.textContent = explanation || '';
            thoughtGroupInfo.classList.toggle('hidden', !explanation);

            if (groups && groups.length > 0) {
                groups.forEach((group, index) => {
                    const groupSpan = document.createElement('span');
                    groupSpan.textContent = group;
                    groupSpan.className = `thought-group ${thoughtGroupColors[index % thoughtGroupColors.length]}`;
                    thoughtGroupDisplay.appendChild(groupSpan);
                });
            }
        }

        async function handleListen(type, button) {
            const text = textInput.value.trim();
            const accent = accentSelect.value;
            if (!text) {
                showMessage('Vui lòng nhập từ hoặc câu để nghe.', 'warning');
                return;
            }
            
            const isNatural = type === 'natural';
            
            let cachedAudio, cachedText, cachedAccent;
            if (isNatural) {
                [cachedAudio, cachedText, cachedAccent] = [lastTTSAudioNatural, lastTTSTextNatural, lastTTSAccentNatural];
            } else { // Clear
                [cachedAudio, cachedText, cachedAccent] = [lastTTSAudioClear, lastTTSTextClear, lastTTSAccentClear];
            }

            if (cachedAudio && cachedText === text && cachedAccent === accent) {
                cachedAudio.play();
                return;
            }

            const ipaFetched = await fetchAndDisplayIPA();
            if (!ipaFetched) return;

            setButtonLoading(button, true);
            try {
                let prompt;
                if (isNatural) {
                    const textWithPauses = currentThoughtGroups.join(" | "); // Use a pipe for clearer pause instruction
                    prompt = `Read ONLY the following text in ${accent}. Do not read any instructions. Pronounce it naturally and fluently. The pipe symbol "|" indicates a very brief, almost imperceptible pause between thought groups, just enough to make the speech sound natural, not choppy. Focus on smooth connected speech within each group. Text: ${textWithPauses}`;
                } else { // Clear
                    prompt = `Say very clearly, with only a slight pause between each word, in ${accent}: ${text}`;
                }

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseModalities: ["AUDIO"] },
                    model: TTS_MODEL
                };

                const data = await fetchWithBackoff(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const audioPart = data?.candidates?.[0]?.content?.parts?.[0];
                if (audioPart && audioPart.inlineData) {
                    const audioData = audioPart.inlineData.data;
                    const mimeType = audioPart.inlineData.mimeType;
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();

                    if(isNatural) {
                        [lastTTSAudioNatural, lastTTSTextNatural, lastTTSAccentNatural] = [audio, text, accent];
                    } else {
                        [lastTTSAudioClear, lastTTSTextClear, lastTTSAccentClear] = [audio, text, accent];
                    }
                } else {
                    throw new Error("Không nhận được dữ liệu âm thanh hợp lệ.");
                }
            } catch (error) {
                handleApiError(error);
            } finally {
                setButtonLoading(button, false);
            }
        }

        function startProgressSimulation() {
            const progressBarInner = document.querySelector('.progress-bar-inner');
            if (!progressBarInner) return;
            
            let width = 0;
            progressBarInner.style.width = '0%';
            
            clearInterval(progressInterval);

            progressInterval = setInterval(() => {
                if (width < 95) {
                    width += Math.random() * 2;
                } else {
                    clearInterval(progressInterval);
                }
                progressBarInner.style.width = Math.min(width, 95) + '%';
            }, 100);
        }

        function stopProgressSimulation() {
            clearInterval(progressInterval);
            const progressBarInner = document.querySelector('.progress-bar-inner');
            if (progressBarInner) {
                progressBarInner.style.width = '100%';
            }
        }

        function startProgressTextAnimation() {
            const steps = [
                "Đang gửi bản ghi âm của bạn...",
                "AI đang phiên âm giọng nói...",
                "Đối chiếu với phiên âm chuẩn...",
                "Phân tích ngữ điệu và cụm tư duy...",
                "Sắp xong rồi! Đang tổng hợp kết quả..."
            ];
            let currentStep = 0;
            progressText.textContent = steps[currentStep];
            
            clearInterval(progressTextInterval);
            progressTextInterval = setInterval(() => {
                currentStep = (currentStep + 1) % steps.length;
                progressText.textContent = steps[currentStep];
            }, 2000);
        }

        function stopProgressTextAnimation() {
            clearInterval(progressTextInterval);
        }


        async function analyzeAudio(audioBlob) {
            const currentAnalysisID = analysisRequestID;

            if (!audioBlob) return;
            lastRecordingBlob = audioBlob;
            listenAgainBtn.disabled = false;

            let ipaReady = (ipaForText === textInput.value.trim() && accentSelect.value === document.body.dataset.accent);
            if (!ipaReady) {
                ipaReady = await fetchAndDisplayIPA();
            }
            if (!ipaReady) {
                showMessage('Không thể phân tích vì không lấy được phiên âm chuẩn.', 'error');
                return;
            }
            
            loader.classList.remove('hidden');
            startProgressTextAnimation();
            startProgressSimulation();
            funFactEl.textContent = `💡 ${funFacts[Math.floor(Math.random() * funFacts.length)]}`;
            funFactEl.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.readAsDataURL(lastRecordingBlob);
            reader.onloadend = async () => {
                if (currentAnalysisID !== analysisRequestID) {
                    console.log(`Analysis request ${currentAnalysisID} cancelled by new request ${analysisRequestID}.`);
                    loader.classList.add('hidden');
                    funFactEl.classList.add('hidden');
                    stopProgressSimulation();
                    stopProgressTextAnimation();
                    return; 
                }

                const base64Audio = reader.result.split(',')[1];
                const isSentence = textInput.value.trim().includes(' ');
                
                const prompt = {
                    "role": "You are PrAI, an expert and empathetic AI phonetics coach. Your primary function is to provide **scientifically rigorous, accurate, and highly constructive** feedback to a Vietnamese learner of English. Your goal is to be an encouraging guide, balancing strict accuracy with an understanding of the learning process.",
                    "context": {
                        "text_to_pronounce": textInput.value.trim(),
                        "target_accent": accentSelect.value === 'American English' ? 'AmE' : 'BrE',
                        "standard_ipa": standardIPA,
                        "ideal_thought_groups": currentThoughtGroups.join(' / '),
                        "is_sentence": isSentence,
                        "phonetic_guidelines": {
                            "instruction": "Your feedback must be direct, precise, and actionable. Maintain a supportive and encouraging tone (addressing the user as 'bạn'). Your goal is to build confidence while correcting errors. **While your #1 priority is accuracy, distinguish between critical errors that hinder communication and minor imperfections.** Frame your feedback positively. For example, instead of 'That's wrong,' say 'Bạn đã làm rất tốt phần đầu của âm này! Để hoàn thiện hơn, hãy thử...'. Crucially, your analysis MUST be based on the provided `standard_ipa`, which represents natural connected speech. Do not deviate from this standard.",
                            "critical_error_focus": {
                                "vowel_quality": "Be extremely critical of vowel sounds based on their phonetic features (height, backness, roundedness, and length).",
                                "diphthong_vs_monophthong": "A common error for Vietnamese speakers is replacing English diphthongs with monophthongs. For example, in 'home' /hoʊm/, the /oʊ/ sound is a clear diphthong, not the Vietnamese monophthong 'ô'. Pronouncing it as a single vowel sound is a major error and MUST be marked 'incorrect'. Similarly, for 'plane' /pleɪn/, the /eɪ/ sound is not the Vietnamese 'ê'. Mark these substitutions as 'incorrect' and explain the gliding motion of the diphthong.",
                                "confusable_vowel_pairs": [
                                    { "pair": "/ʊ/ vs /uː/", "description": "Distinguish VERY carefully between the short, lax, less rounded vowel /ʊ/ (as in 'book', 'put') and the long, tense, more rounded vowel /uː/ (as in 'blue', 'food'). A Vietnamese speaker might pronounce /ʊ/ with too much lip rounding and tension, making it sound like /uː/. This is a significant error. Provide specific feedback about lip rounding and muscle tension." },
                                    { "pair": "/ɪ/ vs /iː/", "description": "Distinguish between the short, lax /ɪ/ (as in 'ship', 'it') and the long, tense /iː/ (as in 'sheep', 'eat'). Feedback should mention tongue position (less high for /ɪ/) and length." },
                                    { "pair": "/æ/ vs /e/", "description": "Distinguish between the open front /æ/ (as in 'cat', 'apple') which requires an open jaw, and the mid-front /e/ (as in 'bed', 'said')." }
                                ],
                                "final_consonants": "Vietnamese speakers often drop or weaken final consonants. A word like 'home' /hoʊm/ without a clear /m/ sound is incorrect. 'Like' /laɪk/ without a final /k/ is incorrect. Be very strict in detecting this.",
                                "voicing": "Pay close attention to the distinction between voiced (/b/, /d/, /g/, /v/, /z/, /ð/, /ʒ/) and voiceless (/p/, /t/, /k/, /f/, /s/, /θ/, /ʃ/) consonants, especially at the end of words.",
                                "aspiration": "Note the lack of aspiration in initial voiceless stops (/p/, /t/, /k/). For example, 'pen' should have a puff of air, which might be missing."
                            }
                        }
                    },
                    "task": `Perform a multi-step, high-fidelity analysis of the user's audio.
                    1.  **Initial Transcription:** First, internally transcribe the user's speech into an IPA string. This is your 'user_ipa'.
                    2.  **Phoneme-by-Phoneme Comparison (Strict):** Compare your 'user_ipa' to the 'standard_ipa' phoneme by phoneme. The 'phoneme_analysis' array MUST contain an object for each phoneme from the standard_ipa, in order.
                        -   **'correct'**: The phoneme is a clear and accurate match for the target accent.
                        -   **'approximate'**: The phoneme is easily intelligible and very close to the target, but with a minor deviation that doesn't significantly impact understanding. Use this to acknowledge good effort that is almost perfect. For example, a vowel that is slightly off in length but correct in quality.
                        -   **'incorrect'**: The phoneme is mispronounced in a way that could lead to misunderstanding. This includes all errors listed in the 'critical_error_focus' section. Provide clear, concise feedback explaining *why* it's incorrect based on phonetic features (e.g., "Âm /ʊ/ của bạn hơi căng và tròn môi quá, nghe gần giống /uː/. Hãy thử thả lỏng môi và phát âm ngắn hơn.").
                    3.  **Scoring:** Calculate the 'overall_score' (0-100). This score MUST be heavily weighted by the phoneme analysis. Critical errors (vowel quality, final consonants, diphthongs) should significantly lower the score. A single critical error should prevent the score from being above 80. Multiple critical errors should result in a much lower score.
                    4.  **Holistic Analysis (if sentence):** Analyze stress, intonation, and thought groups. The feedback should be as precise as the phoneme analysis.
                    5.  **Final Review & Self-Correction:** Before generating the JSON, review your analysis. Ask yourself: "Did I strictly follow the 'critical_error_focus' guidelines? If the user said /bʊk/ for 'book' but it sounded like /buːk/, did I correctly mark /ʊ/ as 'incorrect' and provide specific feedback on lip rounding and tension? Is the feedback specific enough for a Vietnamese learner? Is the score a true reflection of the performance, penalizing critical errors heavily?" Correct any inconsistencies before finalizing the output.
                    Return the result in the specified JSON format.`,
                    "output_format_instruction": {
                        "format": "JSON",
                        "schema": {
                            "speech_detected": "boolean",
                            "overall_score": "number | null",
                            "user_ipa": "string | null",
                            "phoneme_analysis": "[ { \"phoneme\": \"string\", \"status\": \"string ('correct', 'approximate', 'incorrect')\", \"feedback\": \"string | null\" } ] | null",
                            "stress_analysis": "{ \"correctly_placed\": \"boolean\", \"feedback\": \"string\" } | null",
                            "thought_group_analysis?": "{ \"feedback\": \"string\" } | null",
                            "advanced_analysis?": "{ \"intonation\": { \"feedback\": \"string\" }, \"connected_speech\": [ { \"type\": \"string\", \"rule\": \"string\", \"example\": \"string\", \"explanation\": \"string\", \"feedback\": \"string\" } ] } | null",
                            "practice_suggestions": "{ \"youglish_us\": \"string\", \"youglish_uk\": \"string\" } | null"
                        }
                    }
                };

                const payload = {
                    contents: [ { role: "user", parts: [ { text: JSON.stringify(prompt) }, { inlineData: { mimeType: "audio/webm", data: base64Audio } } ] } ],
                    generationConfig: { responseMimeType: "application/json" }
                };

                try {
                    const data = await fetchWithBackoff(TEXT_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (currentAnalysisID !== analysisRequestID) {
                        console.log(`Analysis request ${currentAnalysisID} completed, but a newer request is active. Discarding results.`);
                        return;
                    }

                    const resultText = data.candidates[0].content.parts[0].text;
                    const resultJson = JSON.parse(resultText);
                    displayResults(resultJson);
                    savePracticeSession(resultJson, currentIpaData);
                } catch (error) {
                    if (currentAnalysisID === analysisRequestID) {
                        handleApiError(error);
                    }
                } finally {
                    if (currentAnalysisID === analysisRequestID) {
                        stopProgressSimulation();
                        stopProgressTextAnimation();
                        setTimeout(() => {
                            loader.classList.add('hidden');
                            funFactEl.classList.add('hidden');
                        }, 500);
                    }
                }
            };
        }

        function displayResults(data) {
            if (!data.speech_detected || data.overall_score === null) {
                showMessage("PrAI không nhận diện được giọng nói trong bản ghi âm. Vui lòng thử lại và nói to, rõ hơn nhé.", 'warning');
                analysisResults.classList.add('hidden');
                return;
            }

            const scoreContainer = document.querySelector('.score-container');
            analysisResults.classList.remove('hidden');

            // --- SCORE VISUALS UPDATE ---
            scoreContainer.classList.remove('score-high', 'score-medium', 'score-low');
            overallScore.textContent = `${data.overall_score}`;

            if (data.overall_score > 85) {
                scoreContainer.classList.add('score-high');
            } else if (data.overall_score > 70) {
                scoreContainer.classList.add('score-medium');
            } else {
                scoreContainer.classList.add('score-low');
            }
            // --- END SCORE VISUALS UPDATE ---
            
            phonemeAnalysis.innerHTML = '';
            if (data.phoneme_analysis) {
                data.phoneme_analysis.forEach(p => {
                    const phonemeEl = document.createElement('div');
                    phonemeEl.textContent = p.phoneme;
                    phonemeEl.className = 'phoneme has-tooltip';
                    
                    if (p.status === 'correct') { 
                        phonemeEl.classList.add('status-correct');
                    } else if (p.status === 'approximate') { 
                        phonemeEl.classList.add('status-approximate');
                    } else { 
                        phonemeEl.classList.add('status-incorrect');
                    }

                    if (p.feedback) {
                        const tooltip = document.createElement('div');
                        tooltip.className = 'tooltip absolute bottom-full left-1/2 mb-2 w-64 rounded-lg p-3 text-xs shadow-lg';
                        tooltip.textContent = p.feedback;
                        phonemeEl.appendChild(tooltip);
                    }
                    phonemeAnalysis.appendChild(phonemeEl);
                });
            }

            if (data.stress_analysis) {
                stressAnalysis.innerHTML = data.stress_analysis.feedback;
                stressAnalysis.classList.toggle('text-green-400', data.stress_analysis.correctly_placed);
                stressAnalysis.classList.toggle('text-red-400', !data.stress_analysis.correctly_placed);
            }
            
            if (data.thought_group_analysis && data.thought_group_analysis.feedback) {
                thoughtGroupFeedback.innerHTML = data.thought_group_analysis.feedback;
                thoughtGroupAnalysisResult.classList.remove('hidden');
            } else {
                thoughtGroupAnalysisResult.classList.add('hidden');
            }


            if (data.advanced_analysis) {
                intonationAnalysis.innerHTML = data.advanced_analysis.intonation.feedback;
                connectedSpeechAnalysis.innerHTML = '';
                if (data.advanced_analysis.connected_speech && data.advanced_analysis.connected_speech.length > 0) {
                    data.advanced_analysis.connected_speech.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'connected-speech-item';
                        itemEl.innerHTML = `
                            <h5 class="font-semibold text-accent-primary">${item.type}</h5>
                            <p class="text-sm"><strong class="connected-speech-label">Quy tắc:</strong> ${item.rule}</p>
                            <p class="text-sm"><strong class="connected-speech-label">Ví dụ:</strong> <span class="ipa-text-highlight">${item.example}</span></p>
                            <div class="connected-speech-feedback">
                                <p class="text-sm"><strong class="connected-speech-label">Nhận xét:</strong> ${item.feedback}</p>
                            </div>
                        `;
                        connectedSpeechAnalysis.appendChild(itemEl);
                    });
                } else {
                    connectedSpeechAnalysis.innerHTML = '<p class="text-text-secondary">Không phát hiện hiện tượng nối âm nổi bật trong câu này.</p>';
                }
                showMoreBtn.classList.remove('hidden');
            } else {
                showMoreBtn.classList.add('hidden');
            }

            if (data.practice_suggestions) {
                suggestionLinks.innerHTML = '';
                const { youglish_us, youglish_uk } = data.practice_suggestions;
                
                const usLink = document.createElement('a');
                usLink.href = youglish_us;
                usLink.target = '_blank';
                usLink.className = 'btn btn-primary flex-1';
                usLink.textContent = 'Giọng Mỹ (YouGlish)';
                
                const ukLink = document.createElement('a');
                ukLink.href = youglish_uk;
                ukLink.target = '_blank';
                ukLink.className = 'btn btn-primary flex-1';
                ukLink.textContent = 'Giọng Anh (YouGlish)';

                suggestionLinks.appendChild(usLink);
                suggestionLinks.appendChild(ukLink);
                practiceSuggestions.classList.remove('hidden');
            } else {
                practiceSuggestions.classList.add('hidden');
            }
        }
        
        // --- HISTORY FUNCTIONS ---
        
        function savePracticeSession(analysisData, ipaData) {
            if (!analysisData || analysisData.overall_score === null) return;

            const session = {
                id: Date.now(),
                text: textInput.value.trim(),
                accent: accentSelect.value,
                date: new Date().toISOString(),
                score: analysisData.overall_score,
                analysisData: analysisData,
                ipaData: ipaData
            };
            
            let history = JSON.parse(localStorage.getItem('prAIHistory')) || [];
            history.unshift(session); // Add to the beginning
            
            // Limit history size to 30 items
            if (history.length > 30) {
                history = history.slice(0, 30);
            }
            
            localStorage.setItem('prAIHistory', JSON.stringify(history));
        }
        
        function loadAndShowHistory() {
            historyList.innerHTML = '';
            const history = JSON.parse(localStorage.getItem('prAIHistory')) || [];
            
            if (history.length === 0) {
                historyList.innerHTML = `<p class="text-text-secondary text-center p-4">Chưa có lịch sử luyện tập nào.</p>`;
                clearHistoryBtn.classList.add('hidden');
                return;
            }
            
            clearHistoryBtn.classList.remove('hidden');
            history.forEach(session => {
                const item = document.createElement('div');
                item.className = 'history-item p-3 rounded-lg flex items-center gap-4 cursor-pointer';
                item.dataset.sessionId = session.id;
                
                let scoreClass = 'score-low';
                if (session.score > 85) scoreClass = 'score-high';
                else if (session.score > 70) scoreClass = 'score-medium';
                
                const date = new Date(session.date);
                const formattedDate = `${date.toLocaleDateString('vi-VN')} ${date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}`;

                item.innerHTML = `
                    <div class="history-score border-2 ${scoreClass} rounded-full flex items-center justify-center font-bold text-lg">
                        ${session.score}
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="font-semibold text-text-primary truncate">${session.text}</p>
                        <p class="text-sm text-text-secondary">${formattedDate} - ${session.accent}</p>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-text-secondary flex-shrink-0"><polyline points="9 18 15 12 9 6"></polyline></svg>
                `;
                
                item.addEventListener('click', () => loadSessionFromHistory(session.id));
                historyList.appendChild(item);
            });
        }
        
        function loadSessionFromHistory(sessionId) {
            const history = JSON.parse(localStorage.getItem('prAIHistory')) || [];
            const session = history.find(s => s.id == sessionId);
            
            if (!session) {
                showMessage('Không tìm thấy buổi luyện tập này.', 'error');
                return;
            }
            
            // Reset UI
            resetAll();
            
            // Populate UI with session data
            textInput.value = session.text;
            accentSelect.value = session.accent;
            charCounter.textContent = `${session.text.length} / 150`;

            // Restore IPA data
            standardIPA = session.ipaData.detailed;
            ipaForText = session.text;
            document.body.dataset.accent = session.accent;
            currentThoughtGroups = session.ipaData.thought_groups.groups;
            currentIpaData = session.ipaData;
            
            simpleIpaText.textContent = session.ipaData.simple;
            detailedIpaText.textContent = session.ipaData.detailed;
            displayThoughtGroups(session.ipaData.thought_groups.groups, session.ipaData.thought_groups.explanation);

            // Show controls and results
            controlsSection.classList.remove('hidden');
            displayResults(session.analysisData);
            
            // Close modal
            historyModal.classList.add('hidden');
        }
        
        function clearHistory() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ lịch sử luyện tập không?')) {
                localStorage.removeItem('prAIHistory');
                loadAndShowHistory();
                showMessage('Đã xóa lịch sử luyện tập.', 'success');
            }
        }

        // --- UI & EVENT HANDLERS ---

        function resetAnalysisOnly() {
            analysisResults.classList.add('hidden');
            practiceSuggestions.classList.add('hidden');
            showMoreBtn.classList.add('hidden');
            advancedAnalysis.classList.add('hidden');
            thoughtGroupAnalysisResult.classList.add('hidden');
            showMoreBtn.textContent = 'Thông tin thêm';
        }

        function resetAll() {
            standardIPA = '';
            ipaForText = '';
            controlsSection.classList.add('hidden');
            resetAnalysisOnly();
            lastTTSAudioNatural = null;
            lastTTSTextNatural = '';
            lastTTSAccentNatural = '';
            lastTTSAudioClear = null;
            lastTTSTextClear = '';
            lastTTSAccentClear = '';
            currentThoughtGroups = [];
            currentIpaData = {};
            displayThoughtGroups([], '');
        }

        async function handleRecord() {
            if (isRecording) {
                mediaRecorder.stop();
                return;
            }
            
            analysisRequestID++; // Invalidate any previous, ongoing analysis.

            if (!textInput.value.trim()) {
                showMessage('Vui lòng nhập từ để ghi âm và phân tích.', 'warning');
                return;
            }
            
            resetAnalysisOnly();
            listenAgainBtn.disabled = true;
            lastRecordingBlob = null;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;
                soundDetected = false;
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    isRecording = false;
                    stopWaveform();
                    stream.getTracks().forEach(track => track.stop());
                    
                    const recordBtnText = recordBtn.querySelector('.text');
                    recordBtnText.textContent = '';
                    recordBtnText.classList.add('hidden');
                    recordBtn.querySelector('.icon').classList.remove('hidden');
                    recordBtn.classList.remove('is-recording');

                    if (soundDetected) {
                        analyzeAudio(new Blob(audioChunks, { type: 'audio/webm' }));
                    } else {
                        showMessage("PrAI không phát hiện thấy âm thanh. Vui lòng thử ghi âm lại nhé.", "error");
                    }
                };
                mediaRecorder.start();
                startWaveform(stream);
                const recordBtnText = recordBtn.querySelector('.text');
                recordBtnText.textContent = 'Dừng';
                recordBtnText.classList.remove('hidden');
                recordBtn.querySelector('.icon').classList.add('hidden');
                recordBtn.classList.add('is-recording');
            } catch (error) {
                console.error("Error accessing microphone:", error);
                showMessage('Không thể truy cập micro. Vui lòng cấp quyền và thử lại.', 'error');
            }
        }

        function handleListenAgain() {
            if (lastRecordingBlob) {
                const audioUrl = URL.createObjectURL(lastRecordingBlob);
                replayAudio.src = audioUrl;
                replayAudio.play();
            }
        }

        function startWaveform(stream) {
            uploadBtn.style.display = 'none';
            listenAgainBtn.style.display = 'none';
            waveformContainer.classList.remove('hidden');
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const computedStyle = getComputedStyle(document.documentElement);
            const accentPrimaryColor = computedStyle.getPropertyValue('--accent-primary').trim();
            const accentSuccessColor = computedStyle.getPropertyValue('--accent-success').trim();

            const canvas = waveformEl;
            const canvasCtx = canvas.getContext('2d');

            function draw() {
                waveformAnimationId = requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);

                const averageVolume = dataArray.reduce((sum, value) => sum + value, 0) / bufferLength;
                if (averageVolume > 15) {
                    soundDetected = true;
                }
                
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 1.5;
                let x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 2.5;
                    const gradient = canvasCtx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
                    gradient.addColorStop(0, accentPrimaryColor);
                    gradient.addColorStop(1, accentSuccessColor);
                    canvasCtx.fillStyle = gradient;
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
            draw();
        }

        function stopWaveform() {
            if (waveformAnimationId) cancelAnimationFrame(waveformAnimationId);
            if (audioContext && audioContext.state !== 'closed') audioContext.close();
            uploadBtn.style.display = 'inline-flex';
            listenAgainBtn.style.display = 'inline-flex';
            waveformContainer.classList.add('hidden');
        }

        function toggleAdvancedAnalysis() {
            const isHidden = advancedAnalysis.classList.contains('hidden');
            advancedAnalysis.classList.toggle('hidden');
            showMoreBtn.textContent = isHidden ? 'Ẩn bớt' : 'Thông tin thêm';
        }

        function handleRandomPractice() {
            const randomSentence = practiceSentences[Math.floor(Math.random() * practiceSentences.length)];
            textInput.value = randomSentence;
            charCounter.textContent = `${randomSentence.length} / 150`;
            resetAll();
            fetchAndDisplayIPA();
        }


        // Initial setup
        function init() {
            accentSelect.value = 'British English';

            textInput.addEventListener('input', () => {
                const currentLength = textInput.value.length;
                const maxLength = textInput.getAttribute('maxlength');
                charCounter.textContent = `${currentLength} / ${maxLength}`;
                resetAll();
            });
            accentSelect.addEventListener('change', () => {
                if (textInput.value.trim()) {
                    resetAll();
                    fetchAndDisplayIPA();
                }
            });
            transcribeBtn.addEventListener('click', fetchAndDisplayIPA);
            listenNaturalBtn.addEventListener('click', (e) => handleListen('natural', e.currentTarget));
            listenClearBtn.addEventListener('click', (e) => handleListen('clear', e.currentTarget));
            recordBtn.addEventListener('click', handleRecord);
            listenAgainBtn.addEventListener('click', handleListenAgain);
            showMoreBtn.addEventListener('click', toggleAdvancedAnalysis);
            randomPracticeBtn.addEventListener('click', handleRandomPractice);
            uploadBtn.addEventListener('click', () => audioUploadInput.click());
            
            // History Modal Listeners
            historyBtn.addEventListener('click', () => {
                loadAndShowHistory();
                historyModal.classList.remove('hidden');
            });
            closeHistoryBtn.addEventListener('click', () => historyModal.classList.add('hidden'));
            clearHistoryBtn.addEventListener('click', clearHistory);
            historyModal.addEventListener('click', (e) => {
                if (e.target === historyModal) {
                    historyModal.classList.add('hidden');
                }
            });


            audioUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('audio/')) {
                    const ipaReadyCheck = async () => {
                        let ipaReady = (ipaForText === textInput.value.trim() && accentSelect.value === document.body.dataset.accent);
                        if (!textInput.value.trim()) {
                            showMessage('Vui lòng nhập văn bản tương ứng với file âm thanh trước.', 'warning');
                            return;
                        }
                        if (!ipaReady) {
                            ipaReady = await fetchAndDisplayIPA();
                        }
                        if (!ipaReady) {
                            showMessage('Không thể phân tích vì không lấy được phiên âm chuẩn.', 'error');
                            return;
                        }
                        analysisRequestID++; // Invalidate previous analyses before starting a new one from file upload
                        analyzeAudio(file);
                    };
                    ipaReadyCheck();
                } else if (file) {
                    showMessage('Vui lòng chọn một tệp âm thanh hợp lệ.', 'warning');
                }
                event.target.value = null;
            });

            textInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    fetchAndDisplayIPA();
                }
            });
        }

        init();
    </script>
</body>
</html>
